/*
 * @Descripttion: AD9910
 * @version: v0.0
 * @Author: comestones | 万星阁
 * @Message: comestones@outlook.com
 * @Date: 2023-07-05 12:17:12
 * @LastEditTime: 2023-07-20 12:53:11
 */

#include "ad9910.h"

// 三角波
char RAM_Triangle[4096] = {
0x00,0x00,0x00,0x00, 0x03,0xfc,0x00,0x00, 0x07,0xf8,0x00,0x00, 0x0b,0xf4,0x00,0x00, 0x0f,0xf0,0x00,0x00, 0x13,0xec,0x00,0x00, 0x17,0xe8,0x00,0x00, 0x1b,0xe4,0x00,0x00, 
0x1f,0xe0,0x00,0x00, 0x23,0xdc,0x00,0x00, 0x27,0xd8,0x00,0x00, 0x2b,0xd4,0x00,0x00, 0x2f,0xd0,0x00,0x00, 0x33,0xcc,0x00,0x00, 0x37,0xc8,0x00,0x00, 0x3b,0xc4,0x00,0x00, 
0x3f,0xc0,0x00,0x00, 0x43,0xbc,0x00,0x00, 0x47,0xb8,0x00,0x00, 0x4b,0xb4,0x00,0x00, 0x4f,0xb0,0x00,0x00, 0x53,0xac,0x00,0x00, 0x57,0xa8,0x00,0x00, 0x5b,0xa4,0x00,0x00, 
0x5f,0xa0,0x00,0x00, 0x63,0x9c,0x00,0x00, 0x67,0x98,0x00,0x00, 0x6b,0x94,0x00,0x00, 0x6f,0x90,0x00,0x00, 0x73,0x8c,0x00,0x00, 0x77,0x88,0x00,0x00, 0x7b,0x84,0x00,0x00, 	

0x7b,0x84,0x00,0x00, 0x77,0x88,0x00,0x00, 0x73,0x8c,0x00,0x00, 0x6f,0x90,0x00,0x00, 0x6b,0x94,0x00,0x00, 0x67,0x98,0x00,0x00, 0x63,0x9c,0x00,0x00, 0x5f,0xa0,0x00,0x00, 
0x5b,0xa4,0x00,0x00, 0x57,0xa8,0x00,0x00, 0x53,0xac,0x00,0x00, 0x4f,0xb0,0x00,0x00, 0x4b,0xb4,0x00,0x00, 0x47,0xb8,0x00,0x00, 0x43,0xbc,0x00,0x00, 0x3f,0xc0,0x00,0x00, 
0x3b,0xc4,0x00,0x00, 0x37,0xc8,0x00,0x00, 0x33,0xcc,0x00,0x00, 0x2f,0xd0,0x00,0x00, 0x2b,0xd4,0x00,0x00, 0x27,0xd8,0x00,0x00, 0x23,0xdc,0x00,0x00, 0x1f,0xe0,0x00,0x00, 
0x1b,0xe4,0x00,0x00, 0x17,0xe8,0x00,0x00, 0x13,0xec,0x00,0x00, 0x0f,0xf0,0x00,0x00, 0x0b,0xf4,0x00,0x00, 0x07,0xf8,0x00,0x00, 0x03,0xfc,0x00,0x00, 0x00,0x00,0x00,0x00,

};

//高14位幅度控制
char RAM_Square[4096] = {
0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 
0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 
0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 
0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 0xff,0xff,0x00,0x00, 

0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 
0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
	
};
uint8_t cfr1[4] = {0x00, 0x40, 0x00, 0x00};                                 // cfr1控制字
uint8_t cfr2[4] = {0x01, 0x00, 0x00, 0x00};                                 // cfr2控制字
uint8_t cfr3[4] = {0x05, 0x0F, 0x41, 0x50};                                 // cfr3控制字  25M输入  40倍频  VC0=101   ICP=001;
uint8_t Temp_profile[8] = {0xf0, 0xff, 0x00, 0x00, 0x25, 0x09, 0x7b, 0x42}; // profile控制字 01振幅控制 23相位控制 4567频率调谐字
uint8_t RAM_P0[8] = {0x00};                                                 // RAM_P0控制字
uint8_t Profile0[]={0x3f,0xff,0x00,0x00,0x25,0x09,0x7b,0x42}; //profile0控制字 0x25,0x09,0x7b,0x42,01振幅控制 23相位控制 4567频率调谐字
uint8_t Profile_Addr[8]={0x0e,0x0f,0x10,0x11,0x12,0x13,0x14,0x15};

/**
 * @brief   向ad9910发送数据
 * @param   tx_dat 8位数据
 * @return  None
 */
void AD9910_WriteByte(uint8_t tx_dat)
{
  uint8_t i,sbt;
  sbt=0x80;
	AD9910_SCK(0);
  for (i=0;i<8;i++)
   {
	   if ((tx_dat & sbt)==0) AD9910_SDI(0);		   
	   else AD9910_SDI(1);
	    AD9910_SCK(1);
      sbt=sbt>>1;
      AD9910_SCK(0);
   }
} 

/**
 * @brief   写入多个字节
 * @param   buffer 数组指针
 * @param   length 字节个数
 * @return  None
 */
void AD9910_Write(uint8_t *data,uint16_t length)
{
  for (uint16_t i = 0; i < length; i++)	AD9910_WriteByte(*(data+i));
}  

/**
 * @brief   AD9910初始化
 * @param   None
 * @return  None
 */
void AD9910_Init(void)
{
	uint8_t k,m;
	AD9910_PF2(0);AD9910_PF1(0);AD9910_PF0(0);
  AD9910_DRC(0);AD9910_DRO(0);AD9910_MRT(1);
	HAL_Delay(5);

	AD9910_MRT(0);AD9910_CS(0);	// 发送各个控制字，即基本配置给AD9910
	
	AD9910_WriteByte(CFR1_Addr);
  AD9910_Write(&cfr1[0],4);	
	AD9910_CS(1); 
	for (k=0;k<10;k++);	AD9910_CS(0);

	AD9910_WriteByte(CFR2_Addr);
  AD9910_Write(&cfr2[0],4);		
	AD9910_CS(1); 
	for (k=0;k<10;k++);	AD9910_CS(0);

	AD9910_WriteByte(CFR3_Addr);
  AD9910_Write(&cfr3[0],4);
	AD9910_CS(1);  
	for (k=0;k<10;k++);	AD9910_UP(1);	//UP_DAT=1;
	for (k=0;k<10;k++);	AD9910_UP(0);	//UP_DAT=0;
	HAL_Delay(1);
}
/**
 * @brief   设置选定通道输出
 * @param   channel 通道0-8
 * @return  None
 */
void AD9910_SetProfile(uint8_t channel)
{
	switch (channel)
	{
		case 1:
		{
			AD9910_PF0(0);AD9910_PF1(0);AD9910_PF2(1);
		}break;
		case 2:
		{
			AD9910_PF0(0);AD9910_PF1(1);AD9910_PF2(0);
		}break;
		case 3:
		{
			AD9910_PF0(0);AD9910_PF1(1);AD9910_PF2(1);
		}break;
		case 4:
		{
			AD9910_PF0(1);AD9910_PF1(0);AD9910_PF2(0);
		}break;
		case 5:
		{
			AD9910_PF0(1);AD9910_PF1(0);AD9910_PF2(1);
		}break;
		case 6:
		{
			AD9910_PF0(1);AD9910_PF1(1);AD9910_PF2(0);
		}break;
		case 7:
		{
			AD9910_PF0(1);AD9910_PF1(1);AD9910_PF2(1);
		}break;
		default:
		{
			AD9910_PF0(0);AD9910_PF1(0);AD9910_PF2(0);
		}break;
	}
}   
/**
 * @brief   AD9910发送程序，使用后将配置的信息写入至AD9910
 * @param   channel 选择通道写入
 * @param   change 是否更改输出通道
 * @return  None
 */
void AD9910_Send(uint8_t channel, uint8_t change)
{
	if (change!=0)	AD9910_SetProfile(channel);
	uint8_t m,k;
	AD9910_CS(0);
	AD9910_WriteByte(Profile_Addr[channel]);    //发送profile1控制字地址
  AD9910_Write(&Temp_profile[0],8);
	AD9910_CS(1); 
  for(k=0;k<10;k++);	AD9910_UP(1);
  for(k=0;k<10;k++);	AD9910_UP(0);
  HAL_Delay(1);
}         
/**
 * @brief   AD9910设置普通输出时的频率和幅度
 * @param   Freq 频率为有符号数，在当前设置系数(4.294967296)下最大实际为500M,
 * @param   Amp  幅度0-1
 * @return  None
 */
void AD9910_Set(uint32_t Freq, float Amp)
{
	uint32_t Temp_freq;
	uint16_t Temp_amp;
	Temp_freq=(uint32_t)Freq*4.294967296;	   //将输入频率因子分为四个字节  4.294967296=(2^32)/1000000000
	Temp_amp=Amp*65535;
	Temp_profile[7]=(uint8_t)Temp_freq;
	Temp_profile[6]=(uint8_t)(Temp_freq>>8);
	Temp_profile[5]=(uint8_t)(Temp_freq>>16);
	Temp_profile[4]=(uint8_t)(Temp_freq>>24);
	Temp_profile[1]=(uint8_t)Temp_amp;
	Temp_profile[0]=(uint8_t)(Temp_amp>>8);
	AD9910_Send(0,0);
}
/**
 * @brief   向对应的profile中写入配置
 * @param   None
 * @return  None
 */
void AD9910_SendProfile(void)
{
	uint8_t m,k;
	AD9910_CS(0);
	AD9910_WriteByte(0x0e);    //发送Profile0控制字地址
	AD9910_Write(&Profile0[0],8);
	AD9910_CS(1);
	for(k=0;k<10;k++);	AD9910_UP(1);  // UP_DAT=1
	for(k=0;k<10;k++);	AD9910_UP(0);  // UP_DAT=0
	HAL_Delay(1);
}
/**
 * @brief   在RAM模式下向对应的profile中写入配置
 * @param   None
 * @return  None
 */
void AD9910_SendRAM_Profile(void)
{
	uint8_t m,k;
	AD9910_CS(0);
	AD9910_WriteByte(0x0e);    //发送RAM_P0控制字地址
  AD9910_Write(&RAM_P0[0],8);
	AD9910_CS(1);
	for(k=0;k<10;k++);	AD9910_UP(1);  // UP_DAT=1
	for(k=0;k<10;k++);	AD9910_UP(0);  // UP_DAT=0
	HAL_Delay(1);
}
/**
 * @brief   在写入自己设置的波形时，调用该函数
 * @param   length
 * @return  None
 */
void AD9910_SendRAM(uint32_t length)
{
	uint32_t k;
	AD9910_CS(0);
	AD9910_WriteByte(0x16);    //发送ram控制字地址
	for (length=0; length<4096; length++)	AD9910_WriteByte(RAM_Square[length]); 
	AD9910_CS(1);
	for(k=0;k<10;k++);	AD9910_UP(1);  // UP_DAT=1
	for(k=0;k<10;k++);	AD9910_UP(0);  // UP_DAT=0
	HAL_Delay(1);
}
/**
 * @brief   向AD9910发送控制字
 * @param   None
 * @return  None
 */
void AD9910_SendCtrl(void)
{
	uint8_t m,k;
	AD9910_CS(0);

	AD9910_WriteByte(0x00);    //发送CFR1控制字地址
	for (m=0;m<4;m++)	AD9910_WriteByte(cfr1[m]); 
	AD9910_CS(1); 
	for (k=0;k<10;k++);	AD9910_CS(0);

	AD9910_WriteByte(0x01);    //发送CFR2控制字地址
	for (m=0;m<4;m++)	AD9910_WriteByte(cfr2[m]); 
	AD9910_CS(1);  
	for (k=0;k<10;k++);	AD9910_CS(0);

	AD9910_WriteByte(0x02);    //发送CFR3控制字地址
	for (m=0;m<4;m++)	AD9910_WriteByte(cfr3[m]); 
	AD9910_CS(1);

	for (k=0;k<10;k++);	AD9910_UP(1);  // UP_DAT=1
	for (k=0;k<10;k++);	AD9910_UP(0);  // UP_DAT=0
	HAL_Delay(1);
}
/**
 * @brief   产生三角波
 * @param   Sample_interval 取样间隔
 * @return  None
 */
void AD9910_SetTriangle(uint32_t Sample_interval)//三角波
{
	unsigned long int Temp;
	uint32_t m,k;
	Temp = ((1000000000/(unsigned long int)(Sample_interval)/64/4));//ns
	if(Temp > 0xffff)	Temp = 0xffff;
	RAM_P0[7] = 0x24;
	RAM_P0[6] = 0x00;
	RAM_P0[5] = 0x00;
	RAM_P0[4] = 0xc0;
	RAM_P0[3] = 0x0f;
	RAM_P0[2] = (uint8_t)Temp;
	RAM_P0[1] = (uint8_t)(Temp>>8);
	RAM_P0[0] = 0x00;
	AD9910_SendRAM_Profile();

	AD9910_CS(0);
	AD9910_WriteByte(0x16);    //发送ram控制字地址
	for (m=0; m<4096; m++)	AD9910_WriteByte(RAM_Triangle[m]); 
	AD9910_CS(1);
	for(k=0;k<10;k++);	AD9910_UP(1);  // UP_DAT=1
	for(k=0;k<10;k++);	AD9910_UP(0);  // UP_DAT=0
	HAL_Delay(1);	
	
	cfr1[0] = 0xc0; //RAM 使能，幅度控制
	cfr2[1] = 0x00; //DRG 失能
  AD9910_SendCtrl(); //发送cfrx控制字
}

/**
 * @brief   产生方波
 * @param   Sample_interval 取样间隔
 * @return  None
 */
 void AD9910_SetSquare(uint32_t Sample_interval)//方波
{
	unsigned long int Temp;
	uint32_t m,k;
	Temp = ((1000000000/(unsigned long int)(Sample_interval)/64/4));//ns
	if(Temp > 0xffff)
		Temp = 0xffff;
	RAM_P0[7] = 0x24;
	RAM_P0[6] = 0x00;
	RAM_P0[5] = 0x00;
	RAM_P0[4] = 0xc0;
	RAM_P0[3] = 0x0f;
	RAM_P0[2] = (uint8_t)Temp;
	RAM_P0[1] = (uint8_t)(Temp>>8);
	RAM_P0[0] = 0x00;
	AD9910_SendRAM_Profile();

	AD9910_CS(0);
	AD9910_WriteByte(0x16);    //发送ram控制字地址
	for (m=0; m<4096; m++)	AD9910_WriteByte(RAM_Square[m]); 
	AD9910_CS(1);
	for(k=0;k<10;k++);	AD9910_UP(1);  // UP_DAT=1
	for(k=0;k<10;k++);	AD9910_UP(0);  // UP_DAT=0
	HAL_Delay(1);	
	
	cfr1[0] = 0xc0; //RAM 使能，幅度控制
	cfr2[1] = 0x00; //DRG 失能
  AD9910_SendCtrl(); //发送cfrx控制字
}
/**
 * @brief   设置幅度，仅高14位有效
 * @param   Amp 幅度 0-1
 * @return  None
 */
void AD9910_SetAmp(float Amp)
{
	uint16_t Temp_amp;
	Temp_amp=Amp*16834;
	Temp_profile[1]=(uint8_t)(Temp_amp<<2);
	Temp_profile[0]=(uint8_t)(Temp_amp>>6);
	AD9910_Send(0,0);
}
/**
 * @brief   设置频率
 * @param   Fre 频率值
 * @return  None
 */
void AD9910_SetFreq(int Fre)
{
	uint32_t Temp_freq;	
	Temp_freq=Fre*4.294967296;	   //将输入频率因子分为四个字节  4.294967296=(2^32)/1000000000

	Temp_profile[7]=(uint8_t)Temp_freq;
	Temp_profile[6]=(uint8_t)(Temp_freq>>8);
	Temp_profile[5]=(uint8_t)(Temp_freq>>16);
	Temp_profile[4]=(uint8_t)(Temp_freq>>24);
	AD9910_Send(0,0);
}